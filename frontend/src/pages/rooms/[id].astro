---

import Temperature from '@components/Temperature.astro';
import LightLevel from '@components/LightLevel.astro';
import Humidity from '@components/Humidity.astro';
import SensorTrend from '@components/SensorTrend.astro';
import Layout from '@layouts/Layout.astro';

import { Icon } from 'astro-icon/components';

import { fetchRoomData } from '../../database/api';
import type { SensorResponse, SensorReading } from '../../types/sensor';
import CO from '@components/CO.astro';

const { id } = Astro.params;

const roomId = parseInt(id ?? '0');

const data = (await fetchRoomData(roomId)) as SensorResponse;
const readings = Array.isArray(data?.readings) ? data.readings : [];
const chronologicalReadings: SensorReading[] = [...readings].sort(
	(a, b) => a.timestamp - b.timestamp
);

---

<Layout>
	<div class="flex flex-col items-center w-full gap-10 px-4">
		<h1 class="text-4xl text-center font-bold tracking-wide">Classroom Monitoring Platform</h1>

		<a  href="/"
			class="cursor-pointer border-zinc-600 border-b hover:bg-zinc-400 px-1 transition duration-100">
			<Icon name="material-symbols:arrow-left-alt-rounded" class="inline"/> 
			Back to rooms
		</a>

		<h2 class="text-3xl font-bold">{data.roomName ?? `Room ${roomId}`}</h2>

		<div class="flex flex-col gap-2 items-center">
			<h3 class="text-2xl tracking-wide">Real-time Monitoring</h3>
			<div class="flex gap-2">
				{chronologicalReadings && chronologicalReadings.length > 0 &&				
					<Temperature temp={chronologicalReadings.at(-1)?.temp} />
					<LightLevel light={chronologicalReadings.at(-1)?.light}/>
					<Humidity humid={chronologicalReadings.at(-1)?.humid}/>
					<CO co={chronologicalReadings.at(-1)?.co}/>
				}
			</div>
		</div>

		<hr class="w-full text-gray-600 border border-dashed rounded-full"/>

		<h3 class="text-2xl tracking-wide">Detailed Information</h3>

		<div class="grid grid-cols-2 gap-4">
			<div>
				<h4 class="text-xl text-center">Temperature</h4>
				<SensorTrend
					title="Temperature trend"
					metric="temp"
					accentColor="#f97316"
					readings={chronologicalReadings}
					server:defer
				/>
			</div>

			<div>
				<h4 class="text-xl text-center">Light</h4>
				<SensorTrend
					title="Light % trend"
					metric="light"
					accentColor="#c4b5fd"
					readings={chronologicalReadings}
					server:defer
				/>
			</div>

			<div>
				<h4 class="text-xl text-center">Humidity</h4>
				<SensorTrend
					title="Humidity % trend"
					metric="humid"
					accentColor="#6fa8dc"
					readings={chronologicalReadings}
					server:defer
				/>
			</div>

			<div>
				<h4 class="text-xl text-center">Carbon Monoxide</h4>
				<SensorTrend
					title="CO % trend"
					metric="co"
					accentColor="#714b24"
					readings={chronologicalReadings}
					server:defer
				/>
			</div>
		</div>
		
	</div>
</Layout>
