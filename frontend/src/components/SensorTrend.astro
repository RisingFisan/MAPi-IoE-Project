---
import type { SensorMetric, SensorReading } from '../types/sensor';
import { SENSOR_LABELS } from '../types/sensor';

interface Props {
  title?: string;
  readings: SensorReading[];
  metric: SensorMetric;
  accentColor?: string;
  emptyMessage?: string;
}

const {
  title = 'Sensor trend',
  readings = [],
  metric = 'temp',
  accentColor = '#3b82f6',
  emptyMessage = 'No readings recorded yet.',
} = Astro.props as Props;

const formatTimestamp = (value: number) => {
  if (!Number.isFinite(value)) return 'â€”';
  const ms = value < 10_000_000_000 ? value * 1000 : value;
  const date = new Date(ms);
  if (Number.isNaN(date.getTime())) return String(value);
  return date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
};

const series = readings.map((reading) => ({
  label: formatTimestamp(reading.timestamp),
  value: typeof reading[metric] === 'number' ? Number(reading[metric].toFixed(2)) : null,
}));

const chartPayload = JSON.stringify({
  labels: series.map((point) => point.label),
  values: series.map((point) => point.value),
  accentColor,
  metricLabel: SENSOR_LABELS[metric] ?? metric,
});
---

<div class="chart-card" data-component="sensor-trend">
  <div class="chart-card__header">
    <div>
      <p class="chart-card__eyebrow">{SENSOR_LABELS[metric] ?? metric}</p>
      <h3>{title}</h3>
    </div>
  </div>

  {readings.length === 0 ? (
    <p class="chart-card__empty">{emptyMessage}</p>
  ) : (
    <div class="chart-card__canvas">
      <canvas aria-label={`${title} line chart`} role="img" data-sensor-canvas></canvas>
      <script type="application/json" data-sensor-payload set:html={chartPayload}></script>
    </div>
  )}
</div>

<script>
  import '../scripts/initSensorTrend.ts';
</script>

<style>
  .chart-card {
    width: 100%;
    background: rgba(15, 23, 42, 0.85);
    border: 1px solid rgba(148, 163, 184, 0.25);
    border-radius: 1.25rem;
    padding: 1.25rem;
    box-shadow: 0 20px 35px rgba(15, 23, 42, 0.25);
    color: #fff;
  }

  .chart-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
  }

  .chart-card__eyebrow {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.7;
    margin-bottom: 0.15rem;
  }

  .chart-card h3 {
    font-size: 1.25rem;
    margin: 0;
  }

  .chart-card__canvas {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    min-height: 11rem;
    border-radius: 1rem;
    overflow: hidden;
  }

  .chart-card__canvas canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }

  @supports not (aspect-ratio: 1) {
    .chart-card__canvas {
      padding-top: 56.25%;
    }

    .chart-card__canvas canvas {
      inset: 0;
    }
  }

  .chart-card__empty {
    color: #94a3b8;
    margin: 2rem 0 0;
    text-align: center;
  }
</style>
